name: Deploy to Production

# Define quando o workflow serÃ¡ executado
on:
  push:
    branches:
      - main  # executa quando houver push na branch main
  workflow_dispatch:  # permite executar manualmente pela interface do GitHub

jobs:
  deploy:
    name: Deploy via SSH
    runs-on: ubuntu-latest  # mÃ¡quina virtual que executarÃ¡ o job
    environment: Production
    
    steps:
      # Passo 1: Fazer checkout do cÃ³digo (opcional, mas Ãºtil para validaÃ§Ãµes)
      - name: Checkout code
        uses: actions/checkout@v3
      
      # Passo 2: Conectar via SSH e executar comandos
      - name: Execute deployment commands
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}          # IP do servidor
          username: ${{ secrets.SSH_USERNAME }}  # usuÃ¡rio SSH
          key: ${{ secrets.SSH_PRIVATE_KEY }}    # chave privada
          port: ${{ secrets.SSH_PORT }}          # porta (padrÃ£o 22)
          timeout: 60s                           # timeout da conexÃ£o
          command_timeout: 30m                   # timeout dos comandos
          script: |
            echo "ðŸš€ Iniciando deploy..."
            
            # Navega atÃ© a pasta do projeto
            cd ~/Download/cash-by-card
            
            # Mostra a branch atual
            echo "ðŸ“ Branch atual:"
            git branch
            
            # Faz o pull das alteraÃ§Ãµes
            echo "ðŸ“¥ Baixando alteraÃ§Ãµes..."
            git pull origin main

            # Cria/atualiza .env
            cat > .env << EOF
            SERVER_PORT=3000
            MYSQL_USER=${{ secrets.MYSQL_USER }}
            MYSQL_PASSWORD=${{ secrets.MYSQL_PASSWORD }}
            MYSQL_CONNECTION_STRING=${{ secrets.MYSQL_CONNECTION_STRING }}
            EOF
            
            # Rebuild da imagen
            echo "ðŸ”¨ Construindo imagem..."
            docker build -t cashbycard:1.2 .
            
            # Remove a imagem antiga
            docker image prune -f || true

            # Navega atÃ© a pasta do nginx
            cd ~/Documents
            
            # Para os containers
            echo "ðŸ›‘ Parando containers..."
            docker compose down ${{ vars.SERVICE_NAME }}
            
            # Sobe os containers
            echo "ðŸš¢ Subindo containers..."
            docker compose up -d ${{ vars.SERVICE_NAME }}
            
            # Mostra o status
            echo "âœ… Status dos containers:"
            docker compose ps
            
            echo "âœ¨ Deploy concluÃ­do!"